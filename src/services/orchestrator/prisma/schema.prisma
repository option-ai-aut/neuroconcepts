// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Multi-Tenancy Core ---

model Tenant {
  id        String   @id @default(uuid())
  name      String
  address   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users           User[]
  leads           Lead[]
  properties      Property[]
  emailTemplates  EmailTemplate[] @relation("TenantEmailTemplates")
  exposeTemplates ExposeTemplate[] @relation("TenantExposeTemplates")
  settings        TenantSettings?
  channels        Channel[]
}

model TenantSettings {
  id       String @id @default(uuid())
  tenantId String @unique
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  // Configuration
  smtpConfig    Json? // { host, port, user, pass }
  stripeConfig  Json? // { customerId, subscriptionId }
  aiPersonality Json? // { tone: "professional", language: "de" }
  
  // Calendar Integration (Tokens must be encrypted!)
  googleCalendarConfig Json? // { accessToken, refreshToken, expiryDate, email }
  outlookCalendarConfig Json? // { accessToken, refreshToken, expiryDate, email }
  calendarShareTeam Boolean @default(true)
  
  // Auto-Reply Settings
  autoReplyEnabled Boolean @default(false) // If true, Jarvis sends emails automatically
}

model User {
  id        String @id @default(uuid())
  email     String @unique
  firstName String?
  lastName  String?
  name      String? // Deprecated, keep for backward compatibility
  tenantId  String
  tenant    Tenant @relation(fields: [tenantId], references: [id])
  role      Role   @default(AGENT)

  // Relations
  leads    Lead[] // Leads assigned to this agent
  chats    UserChat[]
  channelMemberships ChannelMember[]
  channelMessages    ChannelMessage[]
}

enum Role {
  SUPER_ADMIN
  ADMIN
  AGENT
}

// --- CRM Core ---

model Lead {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  
  // Contact Info
  email     String
  firstName String?
  lastName  String?
  phone     String?
  
  // Internal
  notes     String?   @db.Text

  // Status
  status    LeadStatus @default(NEW)
  
  // Assignment
  assignedToId String?
  assignedTo   User?   @relation(fields: [assignedToId], references: [id])

  // Context
  propertyId String?
  property   Property? @relation(fields: [propertyId], references: [id])

  // Conversation History
  messages  Message[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, email, propertyId]) // Prevent duplicates per property
}

enum LeadStatus {
  NEW
  CONTACTED
  CONVERSATION
  BOOKED
  LOST
}

model Property {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  
  title       String
  address     String
  price       Decimal?
  rooms       Int?
  area        Float?
  description String?
  
  // AI Context
  aiFacts     String? // "No pets allowed", "South facing balcony"
  
  // Media - separated for AI to distinguish
  images      String[] // Array of S3 URLs for property photos
  floorplans  String[] // Array of S3 URLs for floor plans
  
  // Relations
  leads       Lead[]
  exposes     Expose[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Message {
  id        String   @id @default(uuid())
  leadId    String
  lead      Lead     @relation(fields: [leadId], references: [id])
  
  role      MessageRole // SYSTEM, USER, ASSISTANT
  content   String
  status    MessageStatus @default(SENT) // Default to SENT for backward compatibility, but AI drafts will be DRAFT
  
  createdAt DateTime @default(now())
}

enum MessageRole {
  SYSTEM
  USER
  ASSISTANT
}

enum MessageStatus {
  DRAFT
  SENT
  FAILED
}

model UserChat {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  role      MessageRole
  content   String
  createdAt DateTime @default(now())
}

// --- Team Chat ---

model Channel {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  
  name      String   // "General", "Sales", or "DM-User1-User2"
  type      ChannelType
  
  messages  ChannelMessage[]
  members   ChannelMember[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum ChannelType {
  PUBLIC
  PRIVATE
  DM
}

model ChannelMember {
  id        String   @id @default(uuid())
  channelId String
  channel   Channel  @relation(fields: [channelId], references: [id])
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  joinedAt  DateTime @default(now())
  
  @@unique([channelId, userId])
}

model ChannelMessage {
  id        String   @id @default(uuid())
  channelId String
  channel   Channel  @relation(fields: [channelId], references: [id])
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  content   String   @db.Text
  
  createdAt DateTime @default(now())
}

// --- Orchestrator & Templates ---

model EmailTemplate {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation("TenantEmailTemplates", fields: [tenantId], references: [id])
  
  name      String   // "Exposé Default", "Follow-up 1"
  subject   String   // "Ihr Exposé für {{property.title}}"
  body      String   // HTML/Markdown with placeholders
  
  // AI Configuration
  aiPrompt  String?  // "Rewrite this to be very polite"
  variables Json?    // List of used variables: ["lead.firstName", "property.price"]
  
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- Exposé System ---

model ExposeTemplate {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation("TenantExposeTemplates", fields: [tenantId], references: [id])
  
  name      String   // "Modern Minimalist", "Klassisch Elegant"
  blocks    Json     // Array of ExposeBlock with placeholders
  
  // Styling
  theme     String   @default("default") // "default", "modern", "classic", "luxury"
  
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Instances created from this template
  exposes   Expose[]
}

model Expose {
  id          String   @id @default(uuid())
  tenantId    String
  
  // Relations
  propertyId  String
  property    Property @relation(fields: [propertyId], references: [id])
  
  // Template reference (optional - to detect updates)
  templateId  String?
  template    ExposeTemplate? @relation(fields: [templateId], references: [id])
  createdFromTemplateAt DateTime? // When was this generated from template
  
  // Content (concrete data, no placeholders)
  blocks      Json     // Array of ExposeBlock with real data
  theme       String   @default("default")
  
  // Status
  status      ExposeStatus @default(DRAFT)
  
  // Generated PDF
  pdfUrl      String?  // S3 URL to generated PDF
  pdfGeneratedAt DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum ExposeStatus {
  DRAFT
  PUBLISHED
}
