// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Multi-Tenancy Core ---

model Tenant {
  id        String   @id @default(uuid())
  name      String
  address   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users           User[]
  leads           Lead[]
  properties      Property[]
  emailTemplates  EmailTemplate[] @relation("TenantEmailTemplates")
  exposeTemplates ExposeTemplate[] @relation("TenantExposeTemplates")
  settings        TenantSettings?
  channels        Channel[]
  aiAuditLogs     AiAuditLog[] @relation("TenantAiAuditLogs")
  portalConnections PortalConnection[]
}

model TenantSettings {
  id       String @id @default(uuid())
  tenantId String @unique
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  // Configuration
  smtpConfig    Json? // { host, port, user, pass }
  stripeConfig  Json? // { customerId, subscriptionId }
  aiPersonality Json? // { tone: "professional", language: "de" }
  
  // Calendar Integration (Tokens must be encrypted!)
  googleCalendarConfig Json? // { accessToken, refreshToken, expiryDate, email }
  outlookCalendarConfig Json? // { accessToken, refreshToken, expiryDate, email }
  calendarShareTeam Boolean @default(true)
  
  // Email Integration (Tokens must be encrypted!)
  gmailConfig Json? // { accessToken, refreshToken, expiryDate, email }
  outlookMailConfig Json? // { accessToken, refreshToken, expiryDate, email }
  
  // Auto-Reply Settings
  autoReplyEnabled Boolean @default(false) // If true, Jarvis sends emails automatically
}

model User {
  id        String @id @default(uuid())
  email     String @unique
  firstName String?
  lastName  String?
  name      String? // Deprecated, keep for backward compatibility
  phone     String?
  tenantId  String
  tenant    Tenant @relation(fields: [tenantId], references: [id])
  role      Role   @default(AGENT)

  // Address fields
  street     String?
  postalCode String?
  city       String?
  country    String?

  // Relations
  leads    Lead[] // Leads assigned to this agent
  chats    UserChat[]
  channelMemberships ChannelMember[]
  channelMessages    ChannelMessage[]
  aiAuditLogs AiAuditLog[]
  conversationSummaries ConversationSummary[]
  portalConnections PortalConnection[]
}

enum Role {
  SUPER_ADMIN
  ADMIN
  AGENT
}

// --- CRM Core ---

model Lead {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  
  // Contact Info
  salutation  Salutation @default(NONE)
  formalAddress Boolean @default(true) // true = "Sie", false = "Du"
  email     String
  firstName String?
  lastName  String?
  phone     String?
  
  // Buyer Preferences (for matching with properties)
  budgetMin       Decimal?
  budgetMax       Decimal?
  preferredType   PropertyType? // Wohnung, Haus, etc.
  preferredLocation String? // PLZ oder Stadt
  minRooms        Float?
  minArea         Float?
  timeFrame       LeadTimeFrame? // Wann will der Kunde kaufen/mieten?
  
  // Financing (for qualification)
  financingStatus FinancingStatus @default(NOT_CLARIFIED)
  hasDownPayment  Boolean @default(false)
  
  // Lead Source (for marketing ROI)
  source          LeadSource @default(WEBSITE)
  sourceDetails   String? // z.B. "ImmoScout24" oder "Google Ads"
  
  // Internal
  notes     String?   @db.Text

  // Status
  status    LeadStatus @default(NEW)
  
  // Assignment
  assignedToId String?
  assignedTo   User?   @relation(fields: [assignedToId], references: [id])

  // Context
  propertyId String?
  property   Property? @relation(fields: [propertyId], references: [id])

  // Conversation History
  messages  Message[]
  activities LeadActivity[]
  
  // Documents (Führerschein, Pass, Mietverträge, etc.) - stored as JSON array
  documents   Json?    // Array of { name: string, url: string, type: string, uploadedAt: string }
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, email, propertyId]) // Prevent duplicates per property
}

model LeadActivity {
  id        String   @id @default(uuid())
  leadId    String
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  type      ActivityType
  description String // "Status geändert: Neu → Kontaktiert"
  metadata  Json? // Zusätzliche Daten (z.B. alte/neue Werte)
  
  createdBy String? // User ID
  createdAt DateTime @default(now())
  
  @@index([leadId, createdAt])
}

enum ActivityType {
  LEAD_CREATED
  STATUS_CHANGED
  FIELD_UPDATED
  EMAIL_SENT
  EMAIL_RECEIVED
  NOTE_ADDED
  PROPERTY_ASSIGNED
}

enum LeadTimeFrame {
  IMMEDIATE       // Sofort
  THREE_MONTHS    // 1-3 Monate
  SIX_MONTHS      // 3-6 Monate
  TWELVE_MONTHS   // 6-12 Monate
  LONGTERM        // >12 Monate
}

enum FinancingStatus {
  NOT_CLARIFIED   // Noch nicht geklärt
  PRE_QUALIFIED   // Vorqualifiziert
  APPROVED        // Genehmigt
  CASH_BUYER      // Barzahler
}

enum LeadSource {
  WEBSITE         // Eigene Website
  PORTAL          // Immobilienportal
  REFERRAL        // Empfehlung
  SOCIAL_MEDIA    // Social Media
  COLD_CALL       // Kaltakquise
  EVENT           // Veranstaltung
  OTHER           // Sonstiges
}

enum Salutation {
  NONE            // Keine Anrede
  MR              // Herr
  MS              // Frau
  DIVERSE         // Divers
}

enum LeadStatus {
  NEW
  CONTACTED
  CONVERSATION
  BOOKED
  LOST
}

model Property {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  
  // Basic Info (keep old fields for backward compatibility)
  title       String
  address     String // Legacy: full address string
  price       Decimal? // Legacy: now salePrice or rentCold
  rooms       Int? // Legacy: now rooms (Float)
  area        Float? // Legacy: now livingArea
  description String? @db.Text
  
  // Detailed Address Fields
  street        String?
  houseNumber   String?
  apartmentNumber String? // Türnummer
  staircase     String? // Stiege
  block         String? // Block/Gebäude
  floor         Int?
  zipCode       String?
  city          String?
  district      String? // Bezirk/Stadtteil
  state         String? // Bundesland/Provinz
  country       String @default("Deutschland")
  
  // Type & Marketing
  propertyType PropertyType @default(APARTMENT)
  marketingType MarketingType @default(SALE)
  
  // Price (dynamic)
  salePrice     Decimal?
  rentCold      Decimal?
  rentWarm      Decimal?
  additionalCosts Decimal?
  deposit       String?
  commission    String?
  
  // Areas & Rooms (extended)
  livingArea    Float?
  usableArea    Float?
  plotArea      Float?
  bedrooms      Int?
  bathrooms     Int?
  
  // Building Info
  yearBuilt     Int?
  yearRenovated Int?
  condition     PropertyCondition?
  buildingType  BuildingType?
  totalFloors   Int?
  
  // Energy Certificate (GEG §87)
  energyCertificateType EnergyCertificateType?
  energyEfficiencyClass EnergyEfficiencyClass?
  energyConsumption     Float?
  primaryEnergySource   String?
  energyCertificateValidUntil DateTime?
  
  // Features (JSON)
  features    Json?
  
  // Descriptions (extended)
  locationDescription String? @db.Text
  equipmentDescription String? @db.Text
  
  // AI Context
  aiFacts     String? @db.Text
  
  // Media
  images      String[]
  floorplans  String[]
  videos      String[]
  virtualTour String?
  
  // Documents (PDFs, Word, Excel, etc.) - stored as JSON array with name and url
  documents   Json?    // Array of { name: string, url: string, type: string, uploadedAt: string }
  
  // Status
  status      PropertyStatus @default(ACTIVE)
  priority    PropertyPriority @default(MEDIUM)
  
  // Portal Publishing
  publishedPortals String[] // Array of portal IDs where this property is published
  lastSyncedAt     DateTime?
  
  // Auto-Exposé: Selected template for automatic expose generation when leads come in
  defaultExposeTemplateId String?
  defaultExposeTemplate   ExposeTemplate? @relation(fields: [defaultExposeTemplateId], references: [id])
  
  // Relations
  leads       Lead[]
  exposes     Expose[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum PropertyType {
  APARTMENT
  HOUSE
  COMMERCIAL
  LAND
  GARAGE
  OTHER
}

enum MarketingType {
  SALE
  RENT
  LEASE
}

enum PropertyCondition {
  FIRST_OCCUPANCY
  NEW
  RENOVATED
  REFURBISHED
  WELL_MAINTAINED
  MODERNIZED
  NEEDS_RENOVATION
}

enum BuildingType {
  NEW_BUILDING
  OLD_BUILDING
  MONUMENT
}

enum EnergyCertificateType {
  DEMAND
  CONSUMPTION
}

enum EnergyEfficiencyClass {
  A_PLUS
  A
  B
  C
  D
  E
  F
  G
  H
}

enum PropertyStatus {
  ACTIVE
  RESERVED
  SOLD
  RENTED
  ARCHIVED
}

enum PropertyPriority {
  HIGH
  MEDIUM
  LOW
}

model Message {
  id        String   @id @default(uuid())
  leadId    String
  lead      Lead     @relation(fields: [leadId], references: [id])
  
  role      MessageRole // SYSTEM, USER, ASSISTANT
  content   String
  status    MessageStatus @default(SENT) // Default to SENT for backward compatibility, but AI drafts will be DRAFT
  
  createdAt DateTime @default(now())
}

enum MessageRole {
  SYSTEM
  USER
  ASSISTANT
}

enum MessageStatus {
  DRAFT
  SENT
  FAILED
}

model UserChat {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  role      MessageRole
  content   String
  archived  Boolean  @default(false) // Archiviert nach "Neu starten"
  createdAt DateTime @default(now())
  
  @@index([userId, archived, createdAt])
}

// --- Team Chat ---

model Channel {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  
  name      String   // "General", "Sales", or "DM-User1-User2"
  type      ChannelType
  
  messages  ChannelMessage[]
  members   ChannelMember[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum ChannelType {
  PUBLIC
  PRIVATE
  DM
}

model ChannelMember {
  id        String   @id @default(uuid())
  channelId String
  channel   Channel  @relation(fields: [channelId], references: [id])
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  joinedAt  DateTime @default(now())
  
  @@unique([channelId, userId])
}

model ChannelMessage {
  id        String   @id @default(uuid())
  channelId String
  channel   Channel  @relation(fields: [channelId], references: [id])
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  content   String   @db.Text
  
  createdAt DateTime @default(now())
}

// --- Orchestrator & Templates ---

model EmailTemplate {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation("TenantEmailTemplates", fields: [tenantId], references: [id])
  
  name      String   // "Exposé Default", "Follow-up 1"
  subject   String   // "Ihr Exposé für {{property.title}}"
  body      String   // HTML/Markdown with placeholders
  
  // AI Configuration
  aiPrompt  String?  // "Rewrite this to be very polite"
  variables Json?    // List of used variables: ["lead.firstName", "property.price"]
  
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- Exposé System ---

model ExposeTemplate {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation("TenantExposeTemplates", fields: [tenantId], references: [id])
  
  name      String   // "Modern Minimalist", "Klassisch Elegant"
  blocks    Json     // Array of ExposeBlock with placeholders
  
  // Styling
  theme     String   @default("default") // "default", "modern", "classic", "luxury"
  
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Instances created from this template
  exposes   Expose[]
  
  // Properties using this as default template
  defaultForProperties Property[]
}

model Expose {
  id          String   @id @default(uuid())
  tenantId    String
  
  // Relations
  propertyId  String
  property    Property @relation(fields: [propertyId], references: [id])
  
  // Template reference (optional - to detect updates)
  templateId  String?
  template    ExposeTemplate? @relation(fields: [templateId], references: [id])
  createdFromTemplateAt DateTime? // When was this generated from template
  
  // Content (concrete data, no placeholders)
  blocks      Json     // Array of ExposeBlock with real data
  theme       String   @default("default")
  
  // Status
  status      ExposeStatus @default(DRAFT)
  
  // Generated PDF
  pdfUrl      String?  // S3 URL to generated PDF
  pdfGeneratedAt DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum ExposeStatus {
  DRAFT
  PUBLISHED
}

// --- AI Safety & Audit ---

model AiAuditLog {
  id        String   @id @default(uuid())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  tenantId  String
  tenant    Tenant   @relation("TenantAiAuditLogs", fields: [tenantId], references: [id])
  
  endpoint  String   // "/chat", "/exposes/:id/chat"
  message   String   @db.Text
  response  String?  @db.Text
  
  // Safety flags
  flagged   Boolean  @default(false)
  flagReason String? // "prompt_injection", "forbidden_keyword", etc.
  
  // Metadata
  ipAddress String?
  userAgent String?
  
  createdAt DateTime @default(now())
  
  @@index([tenantId, createdAt])
  @@index([userId, createdAt])
}

model ConversationSummary {
  id           String   @id @default(uuid())
  
  userId       String
  user         User     @relation(fields: [userId], references: [id])
  
  summary      String   @db.Text
  messageCount Int      // How many messages were summarized
  
  createdAt    DateTime @default(now())
  
  @@index([userId, createdAt])
}

// --- Portal Integration ---

model Portal {
  id          String   @id @default(uuid())
  
  // Portal Info
  name        String   // z.B. "Immowelt", "Willhaben"
  slug        String   @unique // z.B. "immowelt", "willhaben"
  country     String   // "DE", "AT", "CH"
  logoUrl     String?
  websiteUrl  String?
  
  // Connection Type
  connectionType PortalConnectionType @default(OPENIMMO_FTP)
  
  // Default FTP Settings (can be overridden per tenant)
  defaultFtpHost String?
  defaultFtpPort Int @default(21)
  
  // Status
  isActive    Boolean @default(true)
  isPremium   Boolean @default(false) // Requires paid subscription
  
  // Relations
  connections PortalConnection[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PortalConnection {
  id          String   @id @default(uuid())
  
  // Hierarchical: Either Tenant-Level (firm) OR User-Level (personal)
  tenantId    String?
  tenant      Tenant?  @relation(fields: [tenantId], references: [id])
  
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])
  
  portalId    String
  portal      Portal   @relation(fields: [portalId], references: [id])
  
  // FTP/SFTP Credentials (encrypted in production!)
  ftpHost     String?
  ftpPort     Int @default(21)
  ftpUsername String?
  ftpPassword String? // TODO: Encrypt!
  ftpPath     String? // Remote directory
  useSftp     Boolean @default(false)
  
  // REST API Credentials (for portals like ImmobilienScout24)
  apiKey      String? // API Key
  apiSecret   String? // API Secret (encrypted)
  apiEndpoint String? // Optional custom API endpoint
  
  // Portal-specific ID
  providerId  String? // Anbieternummer/Kundennummer beim Portal
  
  // Status
  isEnabled   Boolean @default(true)
  lastSyncAt  DateTime?
  lastSyncStatus PortalSyncStatus?
  lastSyncError String?
  
  // Auto-Sync Settings
  autoSyncEnabled Boolean @default(false)
  autoSyncInterval Int @default(24) // Hours
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  syncLogs    PortalSyncLog[]
  
  @@unique([tenantId, portalId])
  @@unique([userId, portalId])
  @@index([tenantId])
  @@index([userId])
}

model PortalSyncLog {
  id              String   @id @default(uuid())
  
  connectionId    String
  connection      PortalConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  
  // Sync Details
  status          PortalSyncStatus
  propertiesTotal Int @default(0)
  propertiesSynced Int @default(0)
  propertiesFailed Int @default(0)
  
  errorMessage    String? @db.Text
  
  startedAt       DateTime @default(now())
  completedAt     DateTime?
  
  @@index([connectionId, startedAt])
}

enum PortalConnectionType {
  OPENIMMO_FTP    // Standard: OpenImmo XML via FTP
  OPENIMMO_SFTP   // OpenImmo XML via SFTP
  REST_API        // Direct REST API (z.B. ImmoScout24)
  SOAP_API        // SOAP API (z.B. Immowelt)
  CSV_FTP         // CSV via FTP
}

enum PortalSyncStatus {
  PENDING
  IN_PROGRESS
  SUCCESS
  PARTIAL_SUCCESS
  FAILED
}
